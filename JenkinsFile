pipeline {
    agent any

    environment {
        IMAGE_NAME = "bookRental"
        CONTAINER_NAME = "bookRental"
        ROLLBACK_CONTAINER_NAME = "bookRental-old"
    }

    stages {
        stage('Checkout') {
            steps {
                echo "ğŸ“¥ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°"
                git branch: 'main', url: 'git@github.com:MeteoRiver/BookRental.git'
            }
        }

         stage('Build & Test') {
            steps {
                sh 'chmod +x ./gradlew'
                sh './gradlew clean build'
            }
        }

        stage('Test') {
            steps {
                sh './gradlew test'
            }
            post {
                failure {
                    error("í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨")
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    def imageTag = "${IMAGE_NAME}:${env.BUILD_NUMBER}"
                    sh "docker build -t ${imageTag} ."
                }
            }
        }

        stage('Deploy Docker') {
            steps {
                def imageTag = "${IMAGE_NAME}:${env.BUILD_NUMBER}"

                // ê¸°ì¡´ ì»¨í…Œì´ë„ˆë¥¼ ë¡¤ë°±ìš©ìœ¼ë¡œ ë³€ê²½
                sh """
                    if docker ps -a --format '{{.Names}}' | grep -q '${CONTAINER_NAME}'; then
                        echo "Stopping existing container..."
                        docker stop ${CONTAINER_NAME} || true
                        docker rename ${CONTAINER_NAME} ${ROLLBACK_CONTAINER_NAME} || true
                    fi
                """

                //ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
                sh """
                        echo "Deploying new version: ${imageTag}"
                        docker run -d --name ${CONTAINER_NAME} -p 8080:8080 ${imageTag}
                    """

                //30ì´ˆ ëŒ€ê¸° í›„ í™•ì¸
                sleep 30
                def status = sh(script: "docker ps -f name=${CONTAINER_NAME} --format '{{.Status}}'", returnStdout: true).trim()
                //ì‹¤íŒ¨ì‹œ ì‚­ì œ í›„ ê¸°ì¡´ê±° ì‹¤í–‰
                if (!status.contains("Up")) {
                    echo "Deployment failed, rolling back..."
                    sh """
                        docker stop ${CONTAINER_NAME} || true
                        docker rename ${ROLLBACK_CONTAINER_NAME} ${CONTAINER_NAME} || true
                        docker start ${CONTAINER_NAME} || true
                    """
                    error("Deployment failed, rolled back to previous version.")
                } else {//ì„±ê³µ ì‹œ ì‹¤í–‰
                    echo "Deployment successful. Removing old container..."
                    sh "docker rm ${ROLLBACK_CONTAINER_NAME} || true"
                }

            }
        }

        stage('Health Check') {
            steps {
                echo "ğŸ” í—¬ìŠ¤ ì²´í¬ ìˆ˜í–‰"
                script {
                    def response = sh(script: "curl -s -o /dev/null -w '%{http_code}' http://localhost:8080/actuator/health", returnStdout: true).trim()
                    if (response != '200') {
                        error "ğŸš¨ ë°°í¬ ì‹¤íŒ¨ - ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜!"
                    }
                }
            }
        }
    }

    post {
        success {
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
        }
        failure {
            echo "ğŸš¨ CI/CD ì‹¤íŒ¨"
        }
    }
}